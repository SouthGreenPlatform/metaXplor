!function e(){"use strict";var n="aptx:branch_event",r="xsd:string",t="parent_branch",a=/^[-+]?[0-9\\.]+$/;e.addParents=function(n){if(n.children)for(var r=n.children.length-1;r>=0;--r){var t=n.children[r];t.parent=n,e.addParents(t)}},e.getTreeRoot=function(e){var n=e;for(!n.parent&&n.children&&1===n.children.length&&(n=n.children[0]);n.parent&&n.parent.parent;)n=n.parent;return n},e.preOrderTraversal=function(n,r){if(r(n),n.children)for(var t=n.children.length-1;t>=0;--t)e.preOrderTraversal(n.children[t],r)},e.preOrderTraversalAll=function(n,r){if(r(n),n.children)for(var t=n.children.length-1;t>=0;--t)e.preOrderTraversalAll(n.children[t],r);else if(n._children)for(var a=n._children.length-1;a>=0;--a)e.preOrderTraversalAll(n._children[a],r)},e.postOrderTraversalAll=function(n,r){if(n.children)for(var t=n.children.length,a=0;a<t;++a)e.postOrderTraversalAll(n.children[a],r);else if(n._children)for(var l=n._children.length,i=0;i<l;++i)e.postOrderTraversalAll(n._children[i],r);r(n)},e.findByNodeName=function(n,r){var t=[];return e.preOrderTraversalAll(n,function(e){e.name===r&&t.push(e)}),t},e.findByTaxonomyCode=function(n,r){var t=[];return e.preOrderTraversalAll(n,function(e){e.taxonomies&&e.taxonomies.length>0&&e.taxonomies[0].code===r&&t.push(e)}),t},e.findByTaxonomyScientificName=function(n,r){var t=[];return e.preOrderTraversalAll(n,function(e){e.taxonomies&&e.taxonomies.length>0&&e.taxonomies[0].scientific_name===r&&t.push(e)}),t},e.reRoot=function(n,r,t){function a(e,n,r){e.children.length<=n?e.children.push(r):e.children[n]=r}if(!n)throw"cannot re-root null tree";if(!r)throw"cannot re-root on null node";if(t||(t=-1),e.isString(r)){var l=e.findByNodeName(n,r);if(l.length>1)throw"node name '"+r+"' is not unique";if(l.length<1)throw"node name '"+r+"' is not found";r=l[0]}n.rooted=!0;var i=e.getTreeRoot(n);if(r.parent&&r.parent.parent)if(r.parent.parent.parent){var c,o,h=r,s={},d=0,u=null,f=h.parent,p=f.parent;if(s.children=[],e.setChildNode(s,0,h),e.setChildNode(s,1,f),c=p.branch_length,o=e.getBranchData(p),p.branch_length=f.branch_length,e.copyBranchData(f,p),e.copyBranchData(h,f),h.branch_length)if(t>=0){var g=h.branch_length-t;h.branch_length=t,f.branch_length=g>=0?g:0}else{var v=h.branch_length/2;h.branch_length=v,f.branch_length=v}else f.branch_length=void 0;for(a(f,e.getChildNodeIndex(f,h),p);p.parent.parent;)h=f,f=p,p=p.parent,a(f,e.getChildNodeIndex(f,h),p),f.parent=h,d=p.branch_length,u=e.getBranchData(p),p.branch_length=c,e.setBranchData(p,o),c=d,o=u;if(2==p.children.length){var m=p.children[1-e.getChildNodeIndex(p,f)];m.parent=f,p.branch_length||m.branch_length?m.branch_length=(p.branch_length>=0?p.branch_length:0)+(m.branch_length>=0?m.branch_length:0):m.branch_length=void 0;var _=e.getBranchData(p);_&&e.setBranchData(m,_);for(var x=f.children.length,b=0;b<x;++b)if(f.children[b]===p){a(f,b,m);break}}else p.parent=f,e.removeChildNode(p,e.getChildNodeIndex(p,f));n.children[0]=s,s.parent=n,e.addParents(n)}else{if(2===r.parent.children.length&&t>=0){var N,O=r.parent.children[0].branch_length+r.parent.children[1].branch_length;N=r.parent.children[0]===r?r.parent.children[1]:r.parent.children[0],r.branch_length=t;var T=O-t;T>=0?N.branch_length=T:N.branch_length=0}if(r.parent.children.length>2){var A=e.getChildNodeIndex(r.parent,r),y=r.branch_length,w=i;w.children.splice(A,1);var C={};if(C.children=[],e.setChildNode(C,0,r),e.setChildNode(C,1,w),e.copyBranchData(r,w),n.children[0]=C,C.parent=n,t>=0){r.branch_length=t;var S=y-t;S>=0?w.branch_length=S:w.branch_length=0}else if(y>=0){var D=y/2;r.branch_length=D,w.branch_length=D}}}else;},e.removeChildNode=function(e,n){if(!e.children)throw"cannot remove the child node for a external node";if(n>=e.children.length||n<0)throw"attempt to get child node "+n+" of a node with "+e.children.length+" child nodes.";e.children[n].parent=void 0,e.children.splice(n,1)},e.setChildNode=function(e,n,r){r.parent=e,e.children.length<=n?e.children.push(r):e.children[n]=r},e.getBranchData=function(e){var n=null;return(e.width||e.color||e.confidences)&&(n={},n.width=e.width,n.color=e.color,n.confidences=e.confidences),n},e.setBranchData=function(e,n){n&&(e.width=n.width,e.color=n.color,e.confidences=n.confidences)},e.unCollapseAll=function(n){e.preOrderTraversal(n,function(e){e._children&&(e.children=e._children,e._children=null)})},e.copyBranchData=function(e,n){n.width=e.width,n.color=e.color,n.confidences=e.confidences},e.getChildNodeIndex=function(e,n){if(!e)throw"cannot get the child index for a root node";for(var r=e.children.length,t=0;t<r;++t)if(e.children[t]===n)return t;throw"unexpected exception: Could not determine the child index for a node"},e.getChildren=function(e){return e._children?e._children:e.children?e.children:[]},e.calcAverageTreeHeight=function(n,r){for(var t=r?r:e.getAllExternalNodes(n),a=t.length,l=0,i=0;i<a;++i)for(var c=t[i];c!=n;)c.branch_length>0&&(l+=c.branch_length),c=c.parent;return l/a},e.setToArray=function(e){var n=[];return e&&e.forEach(function(e){n.push(e)}),n},e.calcMinMaxInSet=function(e){var n=[],r=!0,t=0,a=0;return e&&e.forEach(function(e){e=parseFloat(e),r?(r=!1,t=e,a=e):(e<t&&(t=e),e>a&&(a=e))}),n[0]=t,n[1]=a,n},e.calcMinMeanMaxInSet=function(e){var n=[],r=!0,t=0,a=0,l=0,i=0,c=0;return e&&e.forEach(function(e){e=parseFloat(e),++c,i+=e,r?(r=!1,t=e,a=e):(e<t&&(t=e),e>a&&(a=e))}),c>0&&(l=i/c),n[0]=t,n[1]=l,n[2]=a,n},e.collectProperties=function(n,r,t){var a={};return e.preOrderTraversalAll(n,function(e){if((!t||t!==!0||!e.children&&!e._children)&&e.properties&&e.properties.length>0)for(var n=e.properties.length,l=0;l<n;++l){var i=e.properties[l];if(i.ref&&i.value&&i.datatype&&i.applies_to&&i.applies_to===r){var c=i.ref;a[c]||(a[c]=new Set),a[c].add(i.value)}}}),a},e.collectPropertyRefs=function(n,r,t){var a=new Set;return e.preOrderTraversalAll(n,function(e){if((!t||t!==!0||!e.children&&!e._children)&&e.properties&&e.properties.length>0)for(var n=e.properties.length,l=0;l<n;++l){var i=e.properties[l];i.ref&&i.value&&i.datatype&&i.applies_to&&i.applies_to===r&&a.add(i.ref)}}),a},e.collectBasicTreeProperties=function(a){var l={};return l.internalNodeData=!1,l.nodeNames=!1,l.branchLengths=!1,l.confidences=!1,l.nodeEvents=!1,l.sequences=!1,l.taxonomies=!1,e.preOrderTraversalAll(a,function(e){if(e.name&&e.name.length>0&&(l.nodeNames=!0,(e.children||e._children)&&(l.internalNodeData=!0)),e.branch_length&&e.branch_length>0&&(l.branchLengths=!0),e.events&&(l.nodeEvents=!0),e.sequences&&e.sequences.length>0&&(l.sequences=!0,(e.children||e._children)&&(l.internalNodeData=!0)),e.taxonomies&&e.taxonomies.length>0&&(l.taxonomies=!0,(e.children||e._children)&&(l.internalNodeData=!0)),e.confidences&&e.confidences.length>0&&(l.confidences=!0),e.properties&&e.properties.length>0)for(var a=e.properties.length,i=0;i<a;++i)e.properties[i].ref===n&&e.properties[i].datatype===r&&e.properties[i].applies_to===t&&(l.branchEvents=!0)}),l},e.searchData=function(n,r,t,a,l){function i(e){var n=[];!l&&g.indexOf("+")>=0?n=g.split("+"):n.push(g);for(var r=n.length,i=!0,o=0;o<r;++o){var d=n[o];if(d)if(d=d.trim(),d.length>0){var u=null;d.length>3&&2===d.indexOf(":")&&(u=h(d),u&&(d=d.substring(3)));var f=!1;if(null!==u&&"NN"!==u||!c(e.name,d,t,a,l)?(null===u||"TC"===u)&&e.taxonomies&&e.taxonomies.length>0&&c(e.taxonomies[0].code,d,t,a,l)?f=!0:(null===u||"TS"===u)&&e.taxonomies&&e.taxonomies.length>0&&c(e.taxonomies[0].scientific_name,d,t,a,l)?f=!0:(null===u||"TN"===u)&&e.taxonomies&&e.taxonomies.length>0&&c(e.taxonomies[0].common_name,d,t,a,l)?f=!0:(null===u||"SY"===u)&&e.taxonomies&&e.taxonomies.length>0&&c(e.taxonomies[0].synonym,d,t,a,l)?f=!0:(null===u||"TI"===u)&&e.taxonomies&&e.taxonomies.length>0&&e.taxonomies[0].id&&c(e.taxonomies[0].id.value,d,t,a,l)?f=!0:(null===u||"SN"===u)&&e.sequences&&e.sequences.length>0&&c(e.sequences[0].name,d,t,a,l)?f=!0:(null===u||"GN"===u)&&e.sequences&&e.sequences.length>0&&c(e.sequences[0].gene_name,d,t,a,l)?f=!0:(null===u||"SS"===u)&&e.sequences&&e.sequences.length>0&&c(e.sequences[0].symbol,d,t,a,l)?f=!0:(null===u||"SA"===u)&&e.sequences&&e.sequences.length>0&&e.sequences[0].accession&&c(e.sequences[0].accession.value,d,t,a,l)&&(f=!0):f=!0,!f){i=!1;break}}else i=!1;else i=!1}i&&s.add(e)}function c(e,n,r,t,a){if(!e||!n)return!1;var l=e.trim(),i=n.trim();if(r||a||(l=l.toLowerCase(),i=i.toLowerCase()),a){var c=null;try{c=r?new RegExp(i):new RegExp(i,"i")}catch(e){return!1}return!!c&&l.search(c)>-1}if(t)return l.indexOf(i)>-1;var h=new RegExp("(\\b|_)"+o(i)+"(\\b|_)");return!!h&&l.search(h)>-1}function o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function h(e){var n=e.substring(0,2);return"NN"===n||"TC"===n||"TN"===n||"TS"===n||"TI"===n||"SY"===n||"SN"===n||"GN"===n||"SS"===n||"SA"===n||"AN"===n||"XR"===n||"MS"===n?n:null}var s=new Set;if(!r||!n||n.length<1)return s;var d=n.trim();if(d.length<1)return s;d=d.replace(/\s\s+/g," "),l||(d=d.replace(/\+\++/g,"+"));var u=[];!l&&d.indexOf(",")>=0?u=d.split(","):u.push(d);for(var f=u.length,p=0;p<f;++p){var g=u[p];g&&(g=g.trim(),g.length>0&&e.preOrderTraversalAll(r,i))}return s},e.calcSumOfExternalDescendants=function(n){var r=0;return e.preOrderTraversal(n,function(e){e.children||++r}),r},e.calcSumOfAllExternalDescendants=function(n){var r=0;return e.preOrderTraversalAll(n,function(e){e.children||e._children||++r}),r},e.isHasCollapsedNodes=function(n){var r=!1;return e.preOrderTraversalAll(n,function(e){e._children&&(r=!0)}),r},e.getAllExternalNodes=function(n){var r=[];return e.preOrderTraversalAll(n,function(e){e.children||e._children||r.push(e)}),r},e.calcMaxDepth=function(n){var r=0;return e.preOrderTraversalAll(n,function(n){if(!n.children&&!n._children){var t=e.calcDepth(n);t>r&&(r=t)}}),r},e.calcDepth=function(e){for(var n=0;e.parent&&e.parent.parent;)n++,e=e.parent;return n},e.calcBranchLengthSimpleStatistics=function(n){var r={};r.mean=0,r.min=Number.MAX_VALUE,r.max=0,r.n=0;var t=0;return e.preOrderTraversalAll(n,function(e){e!==n&&e.branch_length&&e.branch_length>=0&&(++r.n,t+=e.branch_length,e.branch_length<r.min&&(r.min=e.branch_length),e.branch_length>r.max&&(r.max=e.branch_length))}),r.n>0&&(r.mean=t/r.n),r},e.calcMaxBranchLength=function(n){var r=0;return e.preOrderTraversalAll(n,function(e){e!==n&&e.branch_length&&e.branch_length>r&&(r=e.branch_length)}),r},e.isHasNodeData=function(e){return e.name&&e.name.length>0||e.taxonomies&&e.taxonomies.length>0||e.sequences&&e.sequences.length>0||e.properties&&e.properties.length>0},e.removeMaxBranchLength=function(n){e.preOrderTraversalAll(n,function(e){e.max&&(e.max=void 0)})},e.collapseToBranchLength=function(n,r){function t(n,r){if(n.children||n._children){n.max||(n.max=e.calcMaxBranchLength(n));var a=n.max;if(a<r)e.collapse(n);else{e.unCollapse(n);for(var l=n.children.length-1;l>=0;l--)t(n.children[l],r)}}}n.children&&1===n.children.length&&t(n.children[0],r)},e.collapseToDepth=function(n,r){function t(n,r,a){if(n.children||n._children)if(r>=a)e.collapse(n);else{e.unCollapse(n),++r;for(var l=n.children.length-1;l>=0;l--)t(n.children[l],r,a)}}n.children&&1===n.children.length&&t(n.children[0],0,r)},e.collapse=function(e){e.children&&(e._children=e.children,e.children=null)},e.unCollapse=function(e){e._children&&(e.children=e._children,e._children=null)},e.parseNewHampshire=function(n){function r(n){var r=n.indexOf("[");if(r>-1){var t=n.substring(r+1,h.length-1);if(a.test(t)){var l=parseFloat(t);if(e.isNumber(l))return l}}return null}for(var t=[],l={},i=n.split(/\s*(;|\(|\)|,|:)\s*/),c=i.length,o=0;o<c;++o){var h=i[o];switch(h){case"(":var s={};l.children=[s],t.push(l),l=s;break;case",":var d={};t[t.length-1].children.push(d),l=d;break;case")":l=t.pop();break;case":":break;default:var u=i[o-1];if(")"===u||"("===u||","===u){if(h&&h.length>0)if("]"===h.charAt(h.length-1)){var f=h.indexOf("[");if(f>-1){var p=r(h);if(null!=p){l.confidences=[];var g={};g.value=p,g.type="unknown",l.confidences.push(g)}l.name=h.substring(0,f)}else l.name=h}else{l.name=h,("'"===l.name.charAt(0)&&"'"===l.name.charAt(l.name.length-1)||'"'===l.name.charAt(0)&&'"'===l.name.charAt(l.name.length-1))&&(l.name=l.name.substring(1,l.name.length-1));var v=l.name.indexOf("[");if(v>-1){var m=l.name.indexOf("]");m>v&&(l.name=l.name.substring(0,v)+l.name.substring(m+1,l.name.length))}}}else if(":"===u&&h&&h.length>0)if("]"===h.charAt(h.length-1)){var _=h.indexOf("[");if(_>-1){var x=r(h);if(null!=x){l.confidences=[];var g={};g.value=x,g.type="unknown",l.confidences.push(g)}var b=parseFloat(h.substring(0,_));e.isNumber(b)&&(l.branch_length=b)}}else{var N=parseFloat(parseFloat(h));e.isNumber(N)&&(l.branch_length=N)}}}var O={};return O.children=[l],e.addParents(O),O},e.isNumber=function(e){return void 0!==e&&null!==e&&e===e},e.getOneDistinctTaxonomy=function(n){var r=null,t=null,a=null,l=null,i=!0,c=!1;if(e.preOrderTraversalAll(n,function(e){if(e.taxonomies&&1===e.taxonomies.length){var n=e.taxonomies[0];if(n.code&&n.code.length>0)if(c=!0,null===t)t=n.code;else if(t!=n.code)return void(i=!1);if(n.scientific_name&&n.scientific_name.length>0)if(c=!0,null===a)a=n.scientific_name;else if(a!=n.scientific_name)return void(i=!1);if(n.common_name&&n.common_name.length>0)if(c=!0,null===l)l=n.common_name;else if(l!=n.common_name)return void(i=!1);if(n.id&&n.id.value&&n.id.value.length>0){c=!0;var o;o=n.id.provider&&n.id.provider.length>0?n.id.provider+":"+n.id.value:n.id.value,null===r?r=o:r!=o&&(i=!1)}}else e.children||e._children||(i=!1)}),!c)return null;if(i===!0){if(a)return a;if(t)return t;if(l)return l;if(r)return r}return null},e.getOneDistinctNodePropertyValue=function(n,r){var t=null,a=!0;return e.preOrderTraversalAll(n,function(e){if(e.properties&&e.properties.length>0){for(var n=e.properties.length,l=!1,i=0;i<n;++i){var c=e.properties[i];if(c.ref&&c.value&&"node"===c.applies_to&&c.ref===r&&c.value.length>0){if(null===t)t=c.value;else if(t!=c.value)return void(a=!1);l=!0}}l||e.children||e._children||(a=!1)}}),null===t?null:a===!0?t:null},e.moveSimpleCharacteristicsToProperties=function(n){function r(e,n){if(n){e.properties||(e.properties=[]);for(var r=!1,t=e.properties.length,a=0;a<t;++a)if(e.properties[a].ref===n.ref){r=!0;break}r||e.properties.push(n)}}var t;t=n.desc?"ird:":"vipr:";var a=t+"Host",l=t+"Country",i=t+"Year",c=t+"HA",o=t+"NA",h="node",s="xsd:string",d="xsd:integer";e.preOrderTraversalAll(n,function(e){if(e.simple_characteristics){var n,t=e.simple_characteristics;t.country&&t.country.length>0&&(n={},n.ref=l,n.datatype=s,n.applies_to=h,n.value=t.country,r(e,n)),t.host&&t.host.length>0&&(n={},n.ref=a,n.datatype=s,n.applies_to=h,n.value=t.host,r(e,n)),t.year&&t.year.length>0&&(n={},n.ref=i,n.datatype=d,n.applies_to=h,n.value=parseInt(t.year),r(e,n)),t.ha&&t.ha.length>0&&(n={},n.ref=c,n.datatype=d,n.applies_to=h,n.value=parseInt(t.ha),r(e,n)),t.na&&t.na.length>0&&(n={},n.ref=o,n.datatype=d,n.applies_to=h,n.value=parseInt(t.na),r(e,n)),e.simple_characteristics=void 0}})},e.toNewHampshire=function(n,r,t,a){function l(n,o){if(n.children){var h=n.children.length;c+="(";for(var s=0;s<h;++s)l(n.children[s],s===h-1);c+=")"}else if(n._children){var d=n._children.length;c+="(";for(var u=0;u<d;++u)l(n._children[u],u===d-1);c+=")"}if(n.name&&n.name.length>0)if(t===!0&&(n.name.indexOf(",")>-1||n.name.indexOf("(")>-1||n.name.indexOf(")")>-1||n.name.indexOf(":")>-1||n.name.indexOf(";")>-1)){var f=i(n.name);c+=f.indexOf(" ")>=0?"'"+f+"'":f}else c+=n.name.indexOf(" ")>=0?"'"+n.name+"'":n.name;void 0!==n.branch_length&&null!==n.branch_length&&(c+=r&&r>0?":"+e.roundNumber(n.branch_length,r):":"+n.branch_length),a&&n.confidences&&1===n.confidences.length&&void 0!==n.confidences[0].value&&null!==n.confidences[0].value&&(c+=r&&r>0?"["+e.roundNumber(n.confidences[0].value,r)+"]":"["+n.confidences[0].value+"]"),o||(c+=",")}function i(e){return e.replace(/,/g,"_").replace(/\(/g,"{").replace(/\)/g,"}").replace(/:/g,"_").replace(/;/g,"_")}var c="";return n.children&&1===n.children.length&&l(n.children[0],!0),c.length>0?c+";":c},e.roundNumber=function(e,n){return Math.round(e*Math.pow(10,n))/Math.pow(10,n)},e.isString=function(e){return"string"==typeof e||e instanceof String},"undefined"!=typeof module&&module.exports&&!global.xmldocAssumeBrowser?module.exports.forester=e:"undefined"!=typeof window?window.forester=e:this.forester=e}();